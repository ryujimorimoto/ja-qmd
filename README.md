# QMD - クイックマークダウン検索
覚えておくべきあらゆる情報を対象にした、オンデバイス検索エンジン。
Markdownノート、会議の書き起こし、ドキュメント、ナレッジベースをインデックス化できます。
キーワード検索にも自然言語検索にも対応。エージェント指向のワークフローに最適です。

QMDは、BM25による全文検索、ベクトルによる意味検索、LLMによる再ランキングを組み合わせ、すべてを node-llama-cpp + GGUFモデルでローカル実行します。

## クイックスタート

```bash
# グローバルインストール
bun install -g https://github.com/tobi/qmd

# ノート、ドキュメント、会議記録用のコレクションを作成
qmd collection add ~/notes --name notes
qmd collection add ~/Documents/meetings --name meetings
qmd collection add ~/work/docs --name docs

# 検索結果を改善するためのコンテキストを追加
qmd context add qmd://notes "個人的なノートとアイデア"
qmd context add qmd://meetings "会議の記録とメモ"
qmd context add qmd://docs "業務ドキュメント"

# 意味検索用の埋め込みを生成
qmd embed

# すべてを横断して検索
qmd search "プロジェクトのタイムライン"      # 高速キーワード検索
qmd vsearch "デプロイ方法"                    # 意味検索
qmd query "四半期計画プロセス"                # ハイブリッド+再ランキング(最高品質)

# 特定のドキュメントを取得
qmd get "meetings/2024-01-15.md"

# docidでドキュメントを取得(検索結果に表示)
qmd get "#abc123"

# グロブパターンで複数のドキュメントを取得
qmd multi-get "journals/2025-05*.md"

# 特定のコレクション内を検索
qmd search "API" -c notes

# エージェント用にすべてのマッチをエクスポート
qmd search "API" --all --files --min-score 0.3
```

## AIエージェントでの使用

QMDの`--json`と`--files`出力フォーマットは、エージェントワークフロー向けに設計されています:

```bash
# LLM用の構造化結果を取得
qmd search "認証" --json -n 10

# 閾値以上のすべての関連ファイルをリスト化
qmd query "エラーハンドリング" --all --files --min-score 0.4

# 完全なドキュメント内容を取得
qmd get "docs/api-reference.md" --full
```

## MCPサーバー
CLIでそのまま使うこともできますが、MCP（Model Context Protocol）サーバーも提供しており、より密な統合が可能です。

**公開されているツール:**

- `qmd_search` - 高速BM25キーワード検索(コレクションフィルター対応)
- `qmd_vsearch` - 意味ベクトル検索(コレクションフィルター対応)
- `qmd_query` - 再ランキング付きハイブリッド検索(コレクションフィルター対応)
- `qmd_get` - パスまたはdocidでドキュメントを取得(あいまい一致の提案付き)
- `qmd_multi_get` - グロブパターン、リスト、またはdocidで複数ドキュメントを取得
- `qmd_status` - インデックスの健全性とコレクション情報

**Claude Desktop設定** (`~/Library/Application Support/Claude/claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "qmd": {
      "command": "qmd",
      "args": ["mcp"]
    }
  }
}
```

**Claude Code設定** (`~/.claude/settings.json`):

```json
{
  "mcpServers": {
    "qmd": {
      "command": "qmd",
      "args": ["mcp"]
    }
  }
}
```

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      QMD ハイブリッド検索パイプライン                            │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  ユーザークエリ    │
                              └────────┬────────┘
                                       │
                        ┌──────────────┴──────────────┐
                        ▼                             ▼
               ┌────────────────┐            ┌────────────────┐
               │ クエリ拡張       │            │  元のクエリ      │
               │ (Qwen3-0.6B)   │            │   (×2 重み)     │
               └───────┬────────┘            └───────┬────────┘
                       │                             │
                       │ 2つの代替クエリ             │
                       └──────────────┬──────────────┘
                                      │
              ┌───────────────────────┼───────────────────────┐
              ▼                       ▼                       ▼
     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
     │  元のクエリ       │     │ 拡張クエリ1       │     │ 拡張クエリ2      │
     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
              │                       │                       │
      ┌───────┴───────┐       ┌───────┴───────┐       ┌───────┴───────┐
      ▼               ▼       ▼               ▼       ▼               ▼
  ┌───────┐       ┌───────┐ ┌───────┐     ┌───────┐ ┌───────┐     ┌───────┐
  │ BM25  │       │ベクトル │ │ BM25  │     │ベクトル│ │ BM25  │     │ベクトル│
  │(FTS5) │       │ 検索   │ │(FTS5) │     │ 検索   │ │(FTS5) │     │ 検索  │
  └───┬───┘       └───┬───┘ └───┬───┘     └───┬───┘ └───┬───┘     └───┬───┘
      │               │         │             │         │             │
      └───────┬───────┘         └──────┬──────┘         └──────┬──────┘
              │                        │                       │
              └────────────────────────┼───────────────────────┘
                                       │
                                       ▼
                          ┌───────────────────────┐
                          │ RRF統合 + ボーナス      │
                          │  元のクエリ: ×2         │
                          │ トップランクボーナス:     │
                          │       +0.05           │
                          │    上位30件を保持       │
                          └───────────┬───────────┘
                                      │
                                      ▼
                          ┌───────────────────────┐
                          │    LLM 再ランキング     │
                          │ (qwen3-reranker)      │
                          │  Yes/No + logprobs    │
                          └───────────┬───────────┘
                                      │
                                      ▼
                          ┌───────────────────────┐
                          │ 位置考慮ブレンド         │
                          │ 上位1-3:   75% RRF     │
                          │ 上位4-10:  60% RRF     │
                          │ 上位11以上: 40% RRF     │
                          └───────────────────────┘
```

## スコアの正規化と統合

### 検索バックエンド

| バックエンド | 生スコア | 変換 | 範囲 |
|------------|---------|------|------|
| FTS (BM25) | SQLite FTS5 BM25 | Math.abs(score) | 0〜約25+ |
| ベクトル | コサイン距離 | 1 / (1 + distance) | 0.0〜1.0 |
| 再ランカー | LLMの0-10評価 | score / 10 | 0.0〜1.0 |

### 統合戦略

`query`コマンドは、位置考慮ブレンディングを伴うReciprocal Rank Fusion (RRF)を使用します:

1. **クエリ拡張**: 元のクエリ(重み付けで×2) + LLMによる1バリエーション
2. **並列検索**: 各クエリがFTSとベクトルインデックスの両方を検索
3. **RRF統合**: すべての結果リストを`score = Σ(1/(k+rank+1))`(k=60)で統合
4. **トップランクボーナス**: どのリストでも#1のドキュメントに+0.05、#2-3に+0.02
5. **上位K選択**: 再ランキング用に上位30候補を選択
6. **再ランキング**: LLMが各ドキュメントをスコアリング(yes/noとlogprobs信頼度)
7. **位置考慮ブレンディング**:
   - RRFランク1-3: 75%検索、25%再ランカー(完全一致を保持)
   - RRFランク4-10: 60%検索、40%再ランカー
   - RRFランク11以上: 40%検索、60%再ランカー(再ランカーをより信頼)

**このアプローチの理由**: 純粋なRRFは、拡張クエリが一致しない場合に完全一致を薄める可能性があります。トップランクボーナスは、元のクエリで#1スコアのドキュメントを保持します。位置考慮ブレンディングは、再ランカーが高信頼度の検索結果を破壊するのを防ぎます。

### スコアの解釈

| スコア | 意味 |
|--------|------|
| 0.8 - 1.0 | 高関連性 |
| 0.5 - 0.8 | 中程度の関連性 |
| 0.2 - 0.5 | やや関連性あり |
| 0.0 - 0.2 | 低関連性 |

## 要件

### システム要件

- Bun >= 1.0.0
- macOS: Homebrew SQLite(拡張サポート用)
  ```bash
  brew install sqlite
  ```

### GGUFモデル (node-llama-cpp経由)

QMDは3つのローカルGGUFモデルを使用します(初回使用時に自動ダウンロード):

| モデル | 用途 | サイズ |
|--------|------|--------|
| embeddinggemma-300M-Q8_0 | ベクトル埋め込み | 約300MB |
| qwen3-reranker-0.6b-q8_0 | 再ランキング | 約640MB |
| Qwen3-0.6B-Q8_0 | クエリ拡張 | 約640MB |

モデルはHuggingFaceからダウンロードされ、`~/.cache/qmd/models/`にキャッシュされます。

## インストール

```bash
bun install
```

## 使用方法

### コレクション管理

```bash
# 現在のディレクトリからコレクションを作成
qmd collection add . --name myproject

# 明示的なパスとカスタムグロブマスクでコレクションを作成
qmd collection add ~/Documents/notes --name notes --mask "**/*.md"

# すべてのコレクションをリスト化
qmd collection list

# コレクションを削除
qmd collection remove myproject

# コレクションをリネーム
qmd collection rename myproject my-project

# コレクション内のファイルをリスト化
qmd ls notes
qmd ls notes/subfolder
```

### ベクトル埋め込みの生成

```bash
# すべてのインデックス済みドキュメントを埋め込み(800トークン/チャンク、15%オーバーラップ)
qmd embed

# すべてを強制的に再埋め込み
qmd embed -f
```

### コンテキスト管理

コンテキストは、コレクションやパスに説明的なメタデータを追加し、検索がコンテンツを理解するのを助けます。

```bash
# コレクションにコンテキストを追加(qmd://仮想パスを使用)
qmd context add qmd://notes "個人的なノートとアイデア"
qmd context add qmd://docs/api "APIドキュメント"

# コレクションディレクトリ内からコンテキストを追加
cd ~/notes && qmd context add "個人的なノートとアイデア"
cd ~/notes/work && qmd context add "仕事関連のノート"

# グローバルコンテキストを追加(すべてのコレクションに適用)
qmd context add / "プロジェクト用のナレッジベース"

# すべてのコンテキストをリスト化
qmd context list

# コンテキストを削除
qmd context rm qmd://notes/old
```

### 検索コマンド

```
┌──────────────────────────────────────────────────────────────────┐
│                        検索モード                                  │
├──────────┬───────────────────────────────────────────────────────┤
│ search   │ BM25全文検索のみ                                        │
│ vsearch  │ ベクトル意味検索のみ                                     │
│ query    │ ハイブリッド: FTS + ベクトル + クエリ拡張 + 再ランキング     │
└──────────┴───────────────────────────────────────────────────────┘
```

```bash
# 全文検索(高速、キーワードベース)
qmd search "認証フロー"

# ベクトル検索(意味的類似性)
qmd vsearch "ログイン方法"

# 再ランキング付きハイブリッド検索(最高品質)
qmd query "ユーザー認証"
```

### オプション

```bash
# 検索オプション
-n <num>           # 結果数(デフォルト: 5、--files/--jsonの場合は20)
-c, --collection   # 特定のコレクションに検索を制限
--all              # すべてのマッチを返す(--min-scoreと併用してフィルタ)
--min-score <num>  # 最小スコア閾値(デフォルト: 0)
--full             # 完全なドキュメント内容を表示
--line-numbers     # 出力に行番号を追加
--index <name>     # 名前付きインデックスを使用

# 出力フォーマット(searchとmulti-get用)
--files            # 出力: docid,score,filepath,context
--json             # スニペット付きJSON出力
--csv              # CSV出力
--md               # Markdown出力
--xml              # XML出力

# getオプション
qmd get <file>[:line]  # ドキュメントを取得、オプションで行から開始
-l <num>               # 返す最大行数
--from <num>           # 行番号から開始

# multi-getオプション
-l <num>           # ファイルあたりの最大行数
--max-bytes <num>  # Nバイトより大きいファイルをスキップ(デフォルト: 10KB)
```

### 出力フォーマット

デフォルト出力は色付きCLIフォーマットです(NO_COLOR環境変数を尊重):

```
docs/guide.md:42 #a1b2c3
Title: ソフトウェアクラフトマンシップ
Context: 業務ドキュメント
Score: 93%

このセクションでは、細部への注意を払って
高品質なソフトウェアを構築する**クラフトマンシップ**について説明します。
関連項目: エンジニアリング原則


notes/meeting.md:15 #d4e5f6
Title: Q4計画
Context: 個人的なノートとアイデア
Score: 67%

開発プロセスにおけるコード品質とクラフトマンシップ
についての議論。
```

- **Path**: コレクション相対パス(例: docs/guide.md)
- **Docid**: 短いハッシュ識別子(例: #a1b2c3) - `qmd get #a1b2c3`で使用
- **Title**: ドキュメントから抽出(最初の見出しまたはファイル名)
- **Context**: `qmd context add`で設定された場合のパスコンテキスト
- **Score**: 色分け(緑 >70%、黄 >40%、その他は薄く)
- **Snippet**: マッチ周辺のコンテキスト、クエリ用語はハイライト

### 例

```bash
# 最小スコア0.3で10件の結果を取得
qmd query -n 10 --min-score 0.3 "API設計パターン"

# LLMコンテキスト用にMarkdown出力
qmd search --md --full "エラーハンドリング"

# スクリプト用JSON出力
qmd query --json "四半期レポート"

# 異なるナレッジベース用に別のインデックスを使用
qmd --index work search "四半期レポート"
```

## インデックスメンテナンス

```bash
# インデックスステータスとコンテキスト付きコレクションを表示
qmd status

# すべてのコレクションを再インデックス
qmd update

# 最初にgit pullして再インデックス(リモートリポジトリ用)
qmd update --pull

# ファイルパスでドキュメントを取得(あいまい一致の提案付き)
qmd get notes/meeting.md

# docidでドキュメントを取得(検索結果から)
qmd get "#abc123"

# 50行目から開始、最大100行
qmd get notes/meeting.md:50 -l 100

# グロブパターンで複数ドキュメントを取得
qmd multi-get "journals/2025-05*.md"

# カンマ区切りリストで複数ドキュメントを取得(docid対応)
qmd multi-get "doc1.md, doc2.md, #abc123"

# multi-getを20KB未満のファイルに制限
qmd multi-get "docs/*.md" --max-bytes 20480

# multi-getをエージェント処理用JSON出力
qmd multi-get "docs/*.md" --json

# キャッシュと孤立データをクリーンアップ
qmd cleanup
```

## データストレージ

インデックス保存場所: `~/.cache/qmd/index.sqlite`

### スキーマ

- `collections` -- 名前とグロブパターン付きのインデックス済みディレクトリ
- `path_contexts` -- 仮想パス(qmd://...)別のコンテキスト説明
- `documents` -- メタデータとdocid(6文字のハッシュ)付きMarkdownコンテンツ
- `documents_fts` -- FTS5全文インデックス
- `content_vectors` -- 埋め込みチャンク(hash, seq, pos、各800トークン)
- `vectors_vec` -- sqlite-vecベクトルインデックス(hash_seqキー)
- `llm_cache` -- キャッシュされたLLM応答(クエリ拡張、再ランクスコア)

## 環境変数

| 変数 | デフォルト | 説明 |
|------|-----------|------|
| XDG_CACHE_HOME | ~/.cache | キャッシュディレクトリの場所 |

## 仕組み

### インデックスフロー

```
コレクション ──► グロブパターン ──► Markdownファイル ──► タイトル解析 ──► コンテンツハッシュ
    │                                                   │              │
    │                                                   │              ▼
    │                                                   │         docid生成
    │                                                   │       (6文字ハッシュ)
    │                                                   │              │
    └──────────────────────────────────────────────────►└──► SQLiteに保存
                                                                       │
                                                                       ▼
                                                                  FTS5インデックス
```

### 埋め込みフロー

ドキュメントは15%オーバーラップで800トークンのチャンクに分割されます:

```
ドキュメント ──► チャンク(800トークン) ──► 各チャンクをフォーマット ──► node-llama-cpp ──► ベクトル保存
                │                        "title | text"         embedBatch()
                │
                └─► チャンクは以下とともに保存:
                    - hash: ドキュメントハッシュ
                    - seq: チャンク順序(0, 1, 2...)
                    - pos: 元の文字位置
```

### クエリフロー(ハイブリッド)

```
クエリ ──► LLM拡張 ──► [元、バリアント1、バリアント2]
                │
      ┌─────────┴─────────┐
      ▼                   ▼
   各クエリについて:    FTS (BM25)
      │                   │
      ▼                   ▼
   ベクトル検索       ランク付きリスト
      │
      ▼
   ランク付きリスト
      │
      └─────────┬─────────┘
                ▼
         RRF統合 (k=60)
         元のクエリ ×2重み
         トップランクボーナス: +0.05/#1、+0.02/#2-3
                │
                ▼
         上位30候補
                │
                ▼
         LLM再ランキング
         (yes/no + logprob信頼度)
                │
                ▼
         位置考慮ブレンド
         ランク1-3:  75% RRF / 25% 再ランカー
         ランク4-10: 60% RRF / 40% 再ランカー
         ランク11以上: 40% RRF / 60% 再ランカー
                │
                ▼
         最終結果
```

## モデル設定

モデルは`src/llm.ts`でHuggingFace URIとして設定されています:

```typescript
const DEFAULT_EMBED_MODEL = "hf:ggml-org/embeddinggemma-300M-GGUF/embeddinggemma-300M-Q8_0.gguf";
const DEFAULT_RERANK_MODEL = "hf:ggml-org/Qwen3-Reranker-0.6B-Q8_0-GGUF/qwen3-reranker-0.6b-q8_0.gguf";
const DEFAULT_GENERATE_MODEL = "hf:ggml-org/Qwen3-0.6B-GGUF/Qwen3-0.6B-Q8_0.gguf";
```

### EmbeddingGemmaプロンプトフォーマット

```typescript
// クエリ用
"task: search result | query: {query}"

// ドキュメント用
"title: {title} | text: {content}"
```

### Qwen3-Reranker

クロスエンコーダー再ランキングのために、node-llama-cppの`createRankingContext()`と`rankAndSort()` APIを使用します。関連性スコア(0.0 - 1.0)でソートされたドキュメントを返します。

### Qwen3 (クエリ拡張)

LlamaChatSession経由でクエリバリエーションを生成するために使用されます。

## ライセンス

MIT
